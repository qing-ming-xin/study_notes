### 分布式协议

##### 两阶段提交协议（2PC）

​		经常用来实现分布式事务。

- **请求阶段**：协调者通知事务参与者准备提交或取消事务，然后进入表决过程。在表决过程中，参与者将告知协调者自己的决策：同意或取消。
- **提交阶段**：协调者将基于第一阶段的投票结果进行决策。当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务，否则协调者通知所有的参与者取消事务。



面临的两种故障：

- 事务参与者发生故障。事务超时，整个事务失败
- 协调者发生故障。协调者发生故障，备用协调者接替完成后续工作，否则发生永久性故障，事务参与者将无法完成事务而一直等待下去

##### Paxos协议

​		用于解决多个节点之间的一致性问题。

执行步骤：

- 批准：Proposer发送accept消息要求所有其他节点接受某个提议值，acceptor可以接受或拒绝
- 确认：如果超过一半的acceptor接受，意味着提议值已经生效，proposer发送acknowledge消息通知所有的acceptor提议生效。



#### 三种流行的变更复制算法

单领导者、多领导者和无领导者

同步复制：主库需要等待从库的确认，确保从库收到写入操作才发送消息

异步复制： 主库发送消息，但不等待从库的响应

半同步：一个从库是同步的，其他的是异步的。如果该同步从库变得不可用或缓慢，则将一个异步从库改为同步运行。这保证至少在两个节点上拥有最新的数据副本（主库和同步从库）。



主库失效：故障切换

​	流程：

​		确认主库失效-选择一个新的主库-重新配置系统以启动新的主库



### 分区【分片】

**分区的目标是在多台机器上均匀分布数据和查询负载，避免出现热点（负载不成比例的节点）。**



一致性哈希

​	一种均匀分配负载的方法，它使用随机选择的分区边界来避免中央控制或分布式共识的需要。

负载偏斜与热点消除

​	若某一个主键非常火爆，则在其开始或结尾添加随机数，将主键分为100种不同的主键，从而存储在不同的分区中，以此减少偏斜。但是需要额外的记录与跟踪，并从这100个主键分布中读取数据后需要额外的合并操作。



基于文档的次级索引进行分区

​	每个分区是完全独立的。每个分区维护自己的次级索引仅覆盖该分区中的文档，不关心存储在其他分区的数据。

​	查询时，需要将查询发送到所有分区，并合并所有返回的结果

基于关键词的次级索引进行分区

​	覆盖所有分区数据的全局索引，并对全局索引进行分区，可以采用与主键不同的分区方式

​	读取更有效，但是写入速率降低且复杂

​	实践中，对全局索引的更新是异步的



再平衡策略

​	固定数量的分区

​		在这种配置中，分区的数量通常在数据库第一次建立时确定，之后不会改变。虽然原则上可以分割和合并分区，但固定数量的分区在操作上更简单，因此许多固定分区数据库选择不实施分区分割。因此，一开始配置的分区数就是你可以拥有的最大节点数量，所以你需要选择足够多的分区以适应未来的增长。但是，每个分区也有管理开销，所以选择太大的数字会适得其反。

​	动态分区

​	每个分区分配给一个节点，每个节点可以处理多个分区，就像固定数量的分区一样。大型分区拆分后，可以将其中的一半转移到另一个节点，以平衡负载。

​	一个空的数据库从一个分区开始，因为没有关于在哪里绘制分区边界的先验信息。数据集开始时很小，直到达到第一个分区的分割点，所有写入操作都必须由单个节点处理，而其他节点则处于空闲状态。为了解决这个问题，HBase 和 MongoDB 允许在一个空的数据库上配置一组初始分区（这被称为 **预分割**，即 pre-splitting）。在键范围分区的情况中，预分割需要提前知道键是如何进行分配的



请求路由

​	首先将所有来自客户端的请求发送到路由层，它决定了应该处理请求的节点，并相应地转发。此路由层本身不处理任何请求；它仅负责分区的负载均衡。



执行并行查询

​	大规模并行处理查询优化器将复杂的查询分解成许多执行阶段和分区，许多可以在数据库集群的不同节点上并行执行





### 事务

事务是应用程序将多个读写操作组合成一个逻辑单元的一种方式。

放弃事务可以提高性能和可用性。

#### ACID

ACID 代表 原子性（Atomicity），一致性（Consistency），隔离性（Isolation） 和 持久性（Durability）。

##### 原子性

ACID 原子性的定义特征是：能够在错误时中止事务，丢弃该事务进行的所有写入变更的能力。 

##### 一致性

ACID 一致性的概念是，对数据的一组特定约束必须始终成立，即 不变式。

##### 隔离性

ACID 意义上的隔离性意味着，同时执行的事务是相互隔离的：它们不能相互冒犯。

##### 持久性

持久性 是一个承诺，即一旦事务成功完成，即使发生硬件故障或数据库崩溃，写入的任何数据也不会丢失。
